**Модель базы данных** 

![Image alt](https://github.com/dmatwe/projects/blob/main/OTUS_SA_ADVANCED/БД%20нагрузка/robot.png)

| Сущность         | clients                          |
| ---------------- | -------------------------------- |
| Описание         | Справочник клиентов              |
| Атрибут сущности | Описание атрибута                |
| client_id        | Идентификатор клиента<br>        |
| FIO              | ФИО                              |
| tel              | Телефон                          |
| email            | Почта                            |
| start_dt         | Дата регистрации                 |
| Сущность         | orders                           |
| Описание         | Cущность заказов клиентов        |
| Атрибут сущности | Описание атрибута                |
| order_id         | Идентификатор заказа             |
| client_id        | Идентификатор клиента<br>        |
| order_dt         | Время заказа (смены статуса)     |
| status           | Статус заказа                    |
| type             | Способ получения заказа          |
| Сущность         | sessions                         |
| Описание         | Cущность сессий клиентов         |
| Атрибут сущности | Описание атрибута                |
| session_id       | Идентификатор сессии             |
| client_id        | Идентификатор клиента<br>        |
| auth_status      | Статус авторизации               |
| auth_type        | Способ авторизации               |
| purchase_flg     | Флаг покупки                     |
| session_dt       | Дата сессии                      |
| Сущность         | orders_items                     |
| Описание         | Cущность позиций заказов         |
| Атрибут сущности | Описание атрибута                |
| order_id         | Идентификатор заказа             |
| item_id          | Идентификатор товара             |
| item_count       | Кол-во товара одной позиции      |
| price            | Цена                             |
| discount         | Размер скидки                    |
| Сущность         | orders_payment                   |
| Описание         | Cущность оплаты заказов клиентов |
| Атрибут сущности | Описание атрибута                |
| order_id         | Идентификатор заказа             |
| price            | Сумма заказа                     |
| written_off      | Списанные баллы                  |
| awarded          | Начисленные баллы                |
| payment_dt       | Дата оплаты                      |
| payment_status   | Статус оплаты                    |
| payment_type     | Тип оплаты                       |
| Сущность         | clients_loaylty                  |
| Описание         | Cущность кол-во баллов клиентов  |
| Атрибут сущности | Описание атрибута                |
| client_id        | Идентификатор клиента            |
| point_count      | Кол-во баллов                    |
| count_dt         | Дата подсчета                    |
| Сущность         | clients_loaylty                  |
| Описание         | Cущность кол-во баллов клиентов  |
| Атрибут сущности | Описание атрибута                |
| Сущность         | dishs                            |
| Описание         | Cущность блюд из меню            |
| Атрибут сущности | Описание атрибута                |
| dish_id          | Идентификатор блюда              |
| category_id      | Идентификатор категории          |
| name             | Наименование блюда               |
| price            | Цена блюда                       |
| Сущность         | dishs_recipe                     |
| Описание         | Cущность рецептов блюда          |
| Атрибут сущности | Описание атрибута                |
| dish_id          | Идентификатор блюда              |
| ingredient_id    | Идентификатор ингредиента        |
| ingredient_count | Кол-во ингредиента               |
| position         | Позиция ингредиента              |
| Сущность         | categorys                        |
| Описание         | Cущность категорий меню          |
| Атрибут сущности | Описание атрибута                |
| category_id      | Идентификатор категории          |
| name             | Наименование категории           |
| Сущность         | ingredients                      |
| Описание         | Cущность категорий меню          |
| Атрибут сущности | Описание атрибута                |
| ingredient_id    | Идентификатор ингредиента        |
| name             | Наименование ингредиента         |



**Требования к производительности**

| Требования к производительности    | 50-й процентиль | 90-й процентиль | 99-й процентиль |
| ---------------------------------- | --------------- | --------------- | --------------- |
| Макс. Транзакций в секунду на базу | 700             | 1000            | 1500            |
| Макс. Сокет соединений на базу     | 56              | 128             | 256             |
| Операции чтения, %                 | 55              | 60              | 30              |
| Операции записи, %                 | 45              | 40              | 70              |
| Случайные операции, %              | 70              | 80              | 90              |
| Последовательные операции, %       | 30              | 20              | 10              |
| Мин. Задержка репликации, секунд   | 4               | 3               | 5               |



**Первичная нагрузка**

| Запросы                                                  | Частота      | Сложность | Типы дисков | Партицирование | Таблица                                   |
| -------------------------------------------------------- | ------------ | --------- | ----------- | -------------- | ----------------------------------------- |
| Селект на просмотр / поиск блюд                          | часто        | 1         | NVMe        | Partition_01   | dishs                                     |
| Селект на просмотр / поиск клиентов                      | часто        | 1         | NVMe        | Partition_01   | clients                                   |
| Селект на просмотр баллов клиентов                       | часто        | 1         | NVMe        | Partition_01   | clients_loaylty                           |
| Селект на просмотр / поиск заказов                       | часто        | 1         | NVMe        | Partition_01   | orders                                    |
| Селект на просмотр состава заказов                       | часто        | 1         | NVMe        | Partition_01   | orders_dishs                              |
| Селект на просмотр оплаты заказов                        | часто        | 1         | NVMe        | Partition_01   | orders_payment                            |
| Селект на просмотр сессий клиентов                       | часто        | 1         | NVMe        | Partition_01   | sessions                                  |
| Селект на просмотр состава блюд                          | часто        | 1         | NVMe        | Partition_01   | dishs_recipe                              |
| Селект на просмотр ингредиентов                          | часто        | 1         | NVMe        | Partition_01   | ingredients                               |
| Добавление клиента в справочник                          | часто        | 2         | SSD         | Partition_02   | clients                                   |
| Добавление блюда в меню                                  | часто        | 2         | SSD         | Partition_02   | dishs                                     |
| Редактирование состава блюд                              | часто        | 2         | SSD         | Partition_02   | dishs_recipe                              |
| Пересчет баллов клиента                                  | часто        | 2         | SSD         | Partition_02   | clients_loaylty                           |
| Редактировать статус заказа                              | часто        | 2         | SSD         | Partition_02   | orders                                    |
| Среднее время жизненного цикла заказа в разрезе статусов | часто        | 2         | SSD         | Partition_02   | orders                                    |
| Отчет за квартал по категориям                           | периодически | 3         | HDD         | Partition_03   | orders + orders_dishs + dishs + categorys |
| Отчет за квартал по блюдам                               | периодически | 3         | HDD         | Partition_03   | orders + orders_dishs + dishs             |
| Отчет за квартал по программе лояльности                 | периодически | 3         | HDD         | Partition_03   | clients_loaylty                           |
| Отчет за квартал по всем заказам в разрезе статусов      | периодически | 3         | HDD         | Partition_03   | orders                                    |

Преобладать будут простые частые запросы на поиск, и создание (т. е. OLTP система).
Однако в рамках приложения необходимо будет предоставление аналитики, статистики как в целом, так и по конкретным точкам и позициям. (т. е. сложные запросы также будут, но будут выполняться раз в неделю или раз в месяц).


Исходя из бизнес требований полученных на интервью можно прогнозировать нагрузку 

1 Год:

1 ресторан
5000 заказов в день

3 года:

50 ресторанов
250000 заказов в день

5 лет:

100 ресторанов
500000 заказов в день

**Размер БД**

| Метрики                                        | через  1 год | через 3 года | через 5 лет |
| ---------------------------------------------- | ------------ | ------------ | ----------- |
| Количество пользователей (U)                   | 2000         | 100000       | 200000      |
| Количество записей в день (L)                  | 5000         | 250000       | 500000      |
| Количество дней в году (D)                     | 365          | 365          | 365         |
| Количество лет истории (Y)                     | 1            | 3            | 5           |
| Средний размер записи (S) в Кб                 | 0,23         | 0,23         | 0,23        |
| Усредненный размер индекса на элемент (I) в Кб | 0,0064       | 0,0064       | 0,0064      |
| Количество индексов (A)                        | 4            | 4            | 4           |
| Коэффициент накладных расходов базы (E)        | 1,4          | 1,4          | 1,4         |
| Количество версий (V)                          | 1            | 1            | 1           |
| Размер БД по формуле Гб                        | 1245,60928   | 9342069,63   | 62280464,2  |
| Выбор инстанса БД                              | 1000Гб       | 200000Гб     | 1000000Гб   |


**Выбор архитектуры**

![Image alt](https://github.com/dmatwe/projects/blob/main/OTUS_SA_ADVANCED/БД%20нагрузка/с4drawio.png)

Использование базы данных PostgreSQL с репликацией и брокером сообщений Kafka для распределения транзакций будет наиболее эффективным по нескольким причинам.

1. Масштабируемость: PostgreSQL позволяет горизонтальное масштабирование с помощью репликации, что обеспечит возможность распределения нагрузки в зависимости от количества ресторанов и заказов. Это позволит легко расширить базу данных при увеличении объема заказов и ресторанов.

2. Надежность и целостность данных: PostgreSQL обеспечивает высокую надежность и целостность данных благодаря своей транзакционной структуре и возможности использования репликации для обеспечения отказоустойчивости.

3. Гибкость и скорость: Kafka, как брокер сообщений, предоставляет гибкую и быструю систему для распределения транзакций между ресторанами и базой данных. Это обеспечивает эффективное обновление и доступ к данным в реальном времени.

4. Масштабируемость Kafka: Kafka также обладает возможностью масштабироваться и использоваться в качестве потоковой платформы для обработки большого объема данных, что подходит для обработки множества заказов в реальном времени.

5. Производительность и оптимизация: В сочетании PostgreSql и Kafka можно достичь высокой производительности и оптимизации запросов за счет эффективного распределения данных и отправки сообщений между различными компонентами системы.

Таким образом, использование PostgreSQL с репликацией и брокером сообщений Kafka обеспечит необходимую масштабируемость, надежность, гибкость и производительность для обработки огромного объема транзакций, обусловленного возрастающим количеством ресторанов и заказов.

