**Расчет нагрузки на систему**

Важно оценить необходимую инфраструктуру для разворачивания и поддержки системы, а также стоимость всего оборудования и процессов.

Хватит ли у заказчика материальных ресурсов, чтобы воплотить все сформулированные пожелания и требования к системе.

***Оценка позволит скорректировать ожидания от продукта.***


**Пользовательский трафик**
<br/>
Минимальный набор метрик, которые необходимо определить

1. ***MAU*** - количество активных пользователей в месяц 
2. ***DAU*** - ежедневное количество активных пользователей 
3. общее количество пользователей на каком-то горизонте (например, 5 лет)
4. Сколько какого контента в среднем производит типичный пользователь в день

***Отталкиваясь от входных бизнес-показателей мы сможем перейти к оценкам
нагрузки:***

1. ***RPS*** - какое максимальное число запросов в секунду будет к частям системы
2. Какое количество одновременных соединений нужно будет удерживать
3. Какой будет нагрузка на сетевой канал и какой общий трафик мы потратим
4. Какое будет приращение занимаемого места и сколько данных накопится
5. Во-сколько нам обойдутся трафик и железо, которые смогут это все поддерживать


**Сетевая нагрузка**
<br/>
Cостоит из удерживаемых соединений в единицу времени и общего объёма трафика, который может пройти через сеть за единицу времени.

***Ограничения по количеству удерживаемых соединений***

Современный сервер может выдержать наплыв в 10 тысяч — 100 тысяч соединений. Если по вашим расчётам количество пользователей выйдет за этот диапазон, следует заложиться на расширение серверных мощностей.


***Ограничения по трафику***

Максимальный предел трафика упирается в пропускную способность выбранной технологии и канала связи.

Вот некоторые данные по пропускной способности:

***Облако*** — до 1GbE в секунду;

***Витая пара*** — до 10GbE в секунду;

***Оптоволокно стандарта QSFP+*** - до 40 GbE;

***Infiniband (IB) — 100+ GB.***  Этот вид соединений используется в суперкомпьютерах и в огромных дата-центрах (очень дорогой вариант).

Также можно вывести общую стоимость трафика. Облачные провайдеры, например, оценивают 1GB трафика от 1 до 10 центов. Таким образом, зная общий трафик за месяц можно оценить стоимость месячного трафика необходимого для функционирования сервиса.


***Вычислительная нагрузка***
<br/>
Под вычислительной нагрузкой обычно подразумевается вычисление количества одновременных запросов пользователей к сервису. Этот показатель исчисляется в RPS (requests per second).

По грубой оценке можно исходить из того, что в простых сценариях ***в облаке** мы сможем выдерживать нагрузку в 
<br/>
***100k RPS*** для текстовых данных
<br/>
***10k RPS*** при чтении в БД
<br/>
***1k RPS*** при записи в БД.

При наличии мощных ***физических серверов*** в тех же сценариях можно прикидывать вероятную нагрузку в 
<br/>
***500k RPS*** для текстовых данных
<br/>
***50k RPS*** при чтении в БД
<br/>
***5k RPS*** при записи в БД.


***Нагрузка на хранилище***
<br/>
Оценив количество создаваемого контента со стороны пользователей, мы можем прикинуть, сколько места он будет занимать, какой постоянный прирост при этом ожидается и, соответственно, сколько того или иного железа нам потребуется для нашей системы.


***HDD*** со скоростью 100-300 МБ/с, каждый диск хранит до 20 ТБ по цене до $500;

***NVMe SSD*** со скоростью 3-5 ГБ/с, каждый диск хранит до 8 TБ по цене до $2000;

***Оперативная память (RAM)*** со скоростью 50 ГБ/с, стоимость планки 128 ГБ около $1000.


В среднем хранение 1 ТБ обойдётся в около $10000 в RAM, $300 на SSD и $30 на HDD.

Можно прикидывать, что в одном сервере будет до 1 ТБ RAM, 50 ТБ SSD или 200 ТБ HDD.

Если дисков много, в игру вступает и среднее количество отказов за год (AFR) в размере 1%.




**Выводы**
<br/>
На какие показатели стоит ориентироваться при расчётах нагрузки на систему:

![Image alt](https://github.com/dmatwe/projects/blob/main/System_design/ФТ%20НФТ%20Сервисов/mbgbtb.jpeg)

![Image alt](https://github.com/dmatwe/projects/blob/main/System_design/ФТ%20НФТ%20Сервисов/mbps.jpeg)


1. Трафик: MAU, DAU, прирост контента в день, всего за 5 лет, соотношение R/W;
2. Сеть: С10k давно не вопрос, 1 Gb p/s даже в облаке, платим не более $0.1/GB;
3. Вычисления: отдаём 100к текста, считываем 10к и записываем 1к простых запросов в БД;
4. Хранилище: HDD 300 MB/s и $30/TB, SSD 5 GB/s и $300/TB, RAM 50GB/s и $10000/TB;
5. В одну машину при этом можно поставить до 1 TB RAM, 50 TB SSD или 200 TB HDD.



**Сокращатель ссылок**

***Зачем нужен данный сервис?***
<br/>
Чтобы превращать длинные ссылки в короткие и делиться ими.

***Функциональные требования***


1. По полной ссылке пользователь может сгенерировать короткую;
2. Когда пользователь переходит по короткой ссылке, он перенаправляется на исходную;
3. У пользователей есть возможность самим выбрать сокращённый синоним;
4. Ссылки «протухают» через какое-то время. Пользователи могут его изменять;
5. Cбор аналитики по переходам.


***Нефункциональные требования***


1. Высокая доступность сервиса — иначе ссылки просто перестают работать;
2. Перенаправление должно происходит с минимальной задержкой;
3. Короткие ссылки должны быть случайны настолько, чтобы их нельзя было подобрать.
4. Предоставление API для разработчиков.

***Вводные данные***

***Сокращений каждый месяц (ShortMonth)*** = 100 000 000 (100М)
<br/>
***DAU*** = 1 000 000
<br/>
***MAU*** = 10 000 000
<br/>
***Сокращений в среднем / 1 пользователь (AVG)*** = 3
<br/>
***Соотношение чтения и записи (Read/Insert)*** = 100 : 1

***Вычисления***

***Кол-во сокращений в месяц*** = AVG * DAU * 31 день ≈ 100 000 000

***Обращений к сервису в месяц*** = Read * ShortMonth = 100 x 100M = 10 миллиардов.

***Нагрузка на создание записей*** = ShortMonth / (месяц / кол-во сек в дне) = 100M / (30 x 86400) ≈ 40 RPS

***Нагрузка чтение записей*** = 40 RPS * 100 = 4000 RPS

***Вес 1 записи*** =  1 KB 
<br/>
***Генерирация трафика в секундах*** = 4040 RPS * 1 KB ≈ 4 Mb/s (Мегабайт в секунду) = 4 * 8 = 32 Mbps (Мегабит в секунду).

***На горизонте 5 лет*** 
<br/>
***Будем хранить*** = ShortMonth * 5 лет * 12 месяцев = 100M x 5 x 12 = 6 миллиардов записей.
<br/>
6 x 10^9 x 1 KB = 6 TB места.

***Можно заключить, что для таких показателей достаточно и одной рабочей станции за несколько тысяч долларов.***

**Хостинг текстов**

***Зачем нужен такой сервис?***
<br/>
Чтобы делиться кусками кода и искать в нём баги вместе.


***Функциональные требования***


1. Пользователи могут загрузить отрывок текста и получить URL для доступа к нему;
2. Пользователи могут загружать только текстовые данные;
3. У пользователей есть возможность выбрать синоним для доступа;
4. Ссылки «протухают» через какое-то время. Пользователи могут его изменять.


***Нефункциональные требования***

1. Высокая надёжность сервиса — загруженные данные не должны исчезать;
2. Высокая доступность сервиса — иначе доступ к нужным данным пропадает;
3. Сохранённые тексты должны отображаться с минимальной задержкой;
4. Короткие ссылки должны быть случайны настолько, чтобы их нельзя было подобрать.

***Вводные данные***

***DAU*** = 500 000
<br/>
***MAU*** = 10 000 000
<br/>
***Загрузки в среднем / 1 пользователь (AVG)*** = 2
<br/>
***Соотношение чтения и записи (Read/Insert)*** = 10 : 1

***Вычисления***

***Загрузок каждый день (Loadings)*** = DAU * AVG = 500 000 * 2 = 1 000 000

***Обращений к сервису в месяц*** = 30 дней * Loadings * Read =  30 * 1 000 000 * 10 = 300 миллионов

***Нагрузка на создание записей в день*** = Loadings / кол-во сек в дне = 1 000 000 / 86400 ≈ 12 RPS

***Нагрузка на создание чтение в день*** = 12 RPS * 10 (Read) = 120 RPS

***Вес 1 записи*** =  10 KB 

***Генерирация трафика в секундах*** = 132 RPS * 10 KB ≈ 1 Mb/s (Мегабайт в секунду) = 1 * 8 = 8 Mbps (Мегабит в секунду).

***На горизонте 5 лет*** 
<br/>
***Будем хранить*** = Loading * 30  дней * 5 лет * 12 месяцев = 1M x 30 x 5 x 12 ≈ 2 миллиарда записей.
<br/>
2 x 10^9 x 10 KB = 20 TB места.

***Можно заключить, что для таких показателей достаточно и одной рабочей станции за несколько тысяч долларов.***

**Автодополнение**

***Зачем нужен такой сервис?***
<br/>
Чтобы при вводе первых букв запроса предлагались варианты дополнения. Например, при поиске «Н» сразу дополнялось до «НФТ купить».

***Функциональные требования***

1. Пользователи вбивают запрос, для него предлагается топ-5 дополнений;
2. Варианты обновляются по мере вбивания букв и слов;
3. Пользователи могут видеть в подсказках предыдущие релевантные результаты;
5. Учитывать прошлую историю запросов, профиль пользователя, контекст.

***Нефункциональные требования***

1. Высокая отзывчивость сервиса — дополнения обновляются почти в реальном времени.


***Вводные данные***

***Обращений к сервису в день*** = 1 миллиард 
<br/>
10 миллионов уникальных запросов покрывают большую часть обращений
<br/>
Запросы состоят в среднем не более чем из 5 слов длины 10.
<br/>
***Имеем: 50 символов на запрос в среднем, т.е. в 200 байт точно поместится.***

***Вычисления***

***Хранение всех запросов за день*** = 200 байт * 10 000 000 = 2 GB

***На горизонте 5 лет*** 
<br/>
Если предположить, что каждый день появляется 5% новых уникальных запросов

***индекс (GB в день)*** = 2GB + 1800 дней * 5% * 2GB = 182 GB 

***Можно заключить, что для таких показателей достаточно и одной рабочей станции за несколько тысяч долларов.***



**Облачный диск**

***Зачем нужен такой сервис?***
<br/>
Чтобы файлы были везде доступны.

***Функциональные требования***

1. Пользователи могут загружать и скачивать свои файлы с любого устройства;
2. Пользователи могут делиться файлами и директориями с другими;
3. Между всеми устройствами происходить автоматическая синхронизация;
4. Можно редактировать файл офлайн, синхронизация произойдет при выходе в сеть.

***Нефункциональные требования***

1. (A) Атомарность — файл либо обновляется, либо нет, но не становится «битым»;
2. (C) Консистентность — при любом сценарии работы данные в облаке всегда валидны;
3. (I) Изоляция — можно править разные файлы с разных устройств, всё будет хорошо;
4. (D) Устойчивость — после зелёной галочки на файле кофе уже можно выливать на ноутбук.


***Вводные данные***

***Пользователей всего*** = 1 миллиард 
<br/>
***DAU*** = 100M
<br/>
***Устройств пользователя*** = 5
<br/>
***Кол-во файлов / пользователь*** = 100 файлов по 100 килобайт, активные меняют 1 файл.

***Вычисления***

***Сеть*** 
<br/>
***трафик в день*** = DAU *  = 100M * 100 КБ = 10TB 
<br/>
***трафик в  секунду*** 10TB (10 000 GB) / 86400 (сек / день) = 115 Mb/s 
<br/>





**Приложение для выкладывания фотографий**

***Зачем нужен такой сервис?***
<br/>
Чтобы делиться фотографиями в зеркале и с едой с друзьями.


***Функциональные требования***

1. Пользователи могут загружать, скачивать и просматривать фотографии;
2. Пользователи могут искать другие фотографии по описанию;
3. Пользователи могут подписываться на фотографии друг друга;
4. Есть лента из популярных фото всех отслеживаемых пользователей.

***Нефункциональные требования***

1. Высокая доступность сервиса — иначе пользователи перейдут в Snapchat или TikTok;
2. Лента с фотографиями должна отображаться за сотни миллисекунд (иначе см п. 1);
3. Консистентность не так критична — подписчики сколько-то потерпят без ваших селфи;
4. Высокая надёжность сервиса — ни одно селфи или фото еды не должно потеряться.


**Телеграм**

***Зачем нужен такой сервис?***
<br/>
Чтобы от общения вас отвлекали с работы, где не купили Slack.

***Функциональные требования***

1. Можно общаться один на один в чатах с другими пользователями;
2. Можно понять, онлайн ли пользователь и когда был последний раз;
3. Сервис обеспечивает постоянное хранение всей истории переписки;
4. Cтикеры, групповые чаты, кружочки с видео, беседы как в Clubhouse, стена, истории.

***Нефункциональные требования***

1. Общение происходит в реальном времени с минимальными задержками;
2. Консистентность — одинаковые сообщения в чатах на всех устройствах;
3. Высокая доступность сервиса — иначе пользователи перейдут в там-там.


**Твиттер**

***Зачем нужен такой сервис?***
<br/>
Чтобы делиться короткими сообщениями со всеми.

***Функциональные требования***

1. Пользователи могут добавлять короткие посты;
2. Посты могут содержать фото или видео;
3. Пользователи могут отслеживать посты других;
4. Есть лента из твитов всех отслеживаемых пользователей;
5. Бонус: поиск, реплаи, горячие темы, уведомления, рекомендации, аватарки с NFT обезьянами.

***Нефункциональные требования***

1. Высокая доступность сервиса — иначе пользователи вернутся в живой журнал;
2. Лента с твитами должна отображаться за сотни миллисекунд (иначе см п. 1);
3. Консистентность не так критична — подписчики сколько-то потерпят без ваших мыслей.


**Нетфликс**

***Зачем нужен такой сервис?***
<br/>
Чтобы смотреть любимые фильмы, сериалы и передачи.

***Функциональные требования***

1. Пользователи могут просматривать фильмы и сериалы;
2. Пользователи могут искать контент по названию;
3. Сервис отслеживает оценки и статистику просмотров;
4. Пользователям рекомендуются новые фильмы и сериалы;
5. Бонус: жанры, популярное, избранное, списки на посмотреть потом.

***Нефункциональные требования***

1. Высокая доступность сервиса — иначе пользователи будут смотреть котиков у конкурентов;
2. Высокая отзывчивость сервиса — видео должны проигрываться без подвисаний;
3. Консистентность не так критична — после недельного ожидания одна минута не заметна.


***DAU*** = 10 миллионов  
<br/>
***фильмов в библиотеке*** = 20000 
<br/>
***Каждый пользователь смотрит пару серий или фильм в течение 1 часа***
<br/>
***Видео*** = 1080p с битрейтом 10 Mbps

***Сеть*** 
<br/>
***трафик*** = 10M x 3600 (сек/час) x 10 Mbps = 40 PB (40 000 000 GB) в день!

**Поиск ресторанов**

***Зачем нужен такой сервис?***
<br/>
Чтобы поесть не холодную еду из зелёных и жёлтых сумок.

***Функциональные требования***

1. Пользователи могут добавлять/обновлять/удалять заведения;
2. Пользователи могут находить подходящие заведения поблизости;
3. Пользователи могут оставлять отзывы к посещённым местам с фото и оценками.
4. Бонус: фильтры по категориям, рекомендации новых заведений.

***Нефункциональные требования***

1. Поиск должен происходить быстро, иначе пользователь закажет доставку;
2. Гораздо большая нагрузка ожидается на подсервис поиска, чем на редактирование.



**Сервис такси**

***Зачем нужен такой сервис?***
<br/>
Чтобы легко доехать из точки А в точку Б с водителем.

***Функциональные требования***

1. Водители могут выходить на смену и ждать заказ;
2. Пассажиры могут находить водителей поблизости;
3. Пассажиры могут заказывать поездку, для неё находится водитель;
4. Позиции отслеживаются с момента принятия поездки и до её окончания. В конце поездки водитель продолжает смену;
5. Бонус: оценки водителям, оценки пассажирам, объяснение ценообразования.

***Нефункциональные требования***

1. Высокая доступность сервиса — иначе пассажиры поедут на метро, а водители на вокзал;
2. Низкое время ожидания для пассажира, маленький простой для водителя.
